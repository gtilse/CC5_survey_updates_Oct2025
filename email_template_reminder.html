<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Client Culture Survey</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favorite/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favorite/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favorite/favicon-16x16.ico">
    <link rel="manifest" href="/assets/favorite/site.webmanifest">
    <link rel="mask-icon" href="/assets/favorite/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Style Sheets -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">

    <style type="text/css">
      /* Score page specific styles */
      #divScorePage {
        max-width: 640px;
        margin: 0 auto;
        padding: 0 20px;
      }

      #divScorePage img {
        display: block;
        margin: 20px 0;
        max-width: 300px;
      }

      #divScorePage > hr {
        margin: 0;
        width: 100%;
      }

      .score-button {
        border: 1px solid #ccc;
        padding: 8px 12px;
        line-height: 2;
        color: #222!important;
        background-color: #FFFFFF;
        border-radius: 8px;
        display:inline-block;
        font-weight: 500;
        text-decoration:none;
        margin: 0;
        min-width: 44px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .score-button:hover {
        background-color: #007bff;
        color: #fff!important;
        border-color: #007bff;
        text-decoration: none;
      }

      .score-button:active,
      .score-button.active {
        background-color: #007bff;
        color: #fff!important;
        border-color: #007bff;
      }

      .score-label {
        color:#A9A9A9;
        font-size: 12px;
      }

      .score-buttons-wrapper {
        margin: 20px 0;
      }

      .score-buttons-container {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .score-labels {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .score-label {
        display: block;
        white-space: nowrap;
      }

      @media (max-width: 640px) {
        .score-buttons-container {
          flex-direction: column-reverse;
          align-items: stretch;
          gap: 8px;
        }

        .score-button {
          width: 100%;
          padding: 16px;
          min-width: auto;
          font-size: 18px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          color: #222!important;
          background-color: #f5f5f5;
        }

        .score-button:hover,
        .score-button:active,
        .score-button.active {
          color: #fff!important;
        }

        .score-button::after {
          content: attr(data-label);
          font-size: 14px;
          font-weight: 400;
          color: #222;
        }

        .score-button:hover::after,
        .score-button:active::after,
        .score-button.active::after {
          color: #fff;
        }

        .score-labels {
          display: none;
        }
      }

      #confirm-instruction {
        display: none;
        margin: 20px 0;
      }

      #confirm-instruction p {
        font-size: 24px;
        font-weight: 300;
        color: #212529;
        margin: 0;
        line-height: 1.4;
      }

      #submit-score-button {
        display: none;
        margin: 30px 0;
        text-align: left;
      }

      #submit-score-button button {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 12px 48px;
        font-size: 18px;
        font-weight: 500;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      #submit-score-button button:hover {
        background-color: #0056b3;
      }

      .footer {
        position: relative;
        width: 100%;
        background-color: #ffffff;
        font-size: 13px;
        text-align: left;
        border-top: none;
        box-shadow: none;
        margin-top: 60px;
        padding: 20px 0 40px 0;
      }

      .footer .container {
        max-width: 640px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .footer hr {
        margin: 0 0 20px 0;
        width: 100%;
      }

      .footer-text {
        display: block;
        margin-top: 5px;
        margin-bottom: 5px;
        padding: 0;
        font-weight: normal;
        font-size: 14px;
        color: #999999;
        text-align: left;
      }

      .footer-link {
        padding: 0;
        color: #999999!important;
        font-size: 14px!important;
        text-decoration: underline;
      }

      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: #333;
        line-height: 1.5;
      }

      h1,h2,h3,h4,h5,h6 {
        font-weight: 400;
        color: #222;
        margin-top: 32px;
        margin-bottom: 12px;
      }

      p {
        font-size: 15px;
        margin-bottom: 6px;
      }
    </style>
  </head>

  <body>
    <!-- Hidden firm name for JavaScript access -->
    <div id="firm-name-holder" data-firm-name="{{FirmName}}" style="display:none;"></div>

    <!-- Page contents -->
    <div id="divScorePage">

      <!-- Logo -->
      {{LOGO_IMAGE}}
      <hr>

      <!-- Webview greeting (hidden by default, shown in webview mode) -->
      <h2 id="webview-greeting" style="display:none; font-size: 21px; text-align: left; margin-top: 20px; margin-bottom: 20px;">Thanks for taking a moment to share your feedback.</h2>

      <!-- Divider after greeting (hidden by default, shown in webview mode) -->
      <hr id="webview-divider" style="display:none;"/>

      <!-- Confirmation instruction (hidden initially, shown for bot protection) -->
      <div id="confirm-instruction">
        <p>Thank you.<br>Can you please confirm your score of <span id="score-value"></span> below.</p>
      </div>

      <!-- Email intro text -->
      <div id="email-intro">
        {{EMAIL_HTML}}
      </div>

      <!-- NPS question only (hidden by default, shown in webview mode) -->
      <div id="nps-question-only" style="display:none; font-size: 21px; font-weight: 400; text-align: left; margin-top: 20px; margin-bottom: 20px;"></div>

      <!-- Score buttons -->
      <div class="score-buttons-wrapper">
        <div class="score-buttons-container">
          <a class="score-button" data-label="Least likely" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=0" target="_blank">0</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=1" target="_blank">1</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=2" target="_blank">2</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=3" target="_blank">3</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=4" target="_blank">4</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=5" target="_blank">5</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=6" target="_blank">6</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=7" target="_blank">7</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=8" target="_blank">8</a>
          <a class="score-button" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=9" target="_blank">9</a>
          <a class="score-button" data-label="Most likely" href="{{WEB_ROOT}}survey/survey.php?id={{OBJECTID}}&type={{SURVEY_TYPE}}#score=10" target="_blank">10</a>
        </div>
        <div class="score-labels">
          <span class="score-label">Least likely</span>
          <span class="score-label">Most likely</span>
        </div>
      </div>

      <!-- Submit Score Button (hidden initially, shown in confirmation mode) -->
      <div id="submit-score-button">
        <button type="button" id="btn-submit-score">Submit Score</button>
      </div>

      <!-- Divider (hidden in webview) -->
      <div id="email-divider"></div>

      <!-- Explanatory text (hidden in webview) -->
      <div id="email-explanation"></div>

    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container" style="padding-bottom:20px;">
        <hr style="border:none;border-top:1px solid #eee;margin:36px 0 8px 0;">

        <p style="font-size:13px;color:#777;text-align:left;line-height:1.4;margin:0;">
          <span style="display:block;margin-bottom:5px;"><strong>Independent quality assurance for leading firms</strong> — a Client Culture service.</span>
          <span style="display:block;margin-bottom:5px;">If you have any questions about this request, please contact your usual contact at {{FirmName}}.</span>
          <span style="display:block;"><a href="https://clientculture.com" style="color:#777;text-decoration:underline;">Powered by Client Culture</a> — empowering teams to deliver client excellence.</span>
        </p>
      </div>
    </footer>

    <div style="display:none">{{UTRACK}}</div>

    <script type="text/javascript">
      // Wait for DOM to be fully loaded
      (function() {
        // Only run on intermediate page (no &score= parameter in URL)
        if (window.location.search.indexOf('score=') > -1) {
          return; // Exit if we're on the Angular form page
        }

        // Function to clean up intermediate page and handle score pre-selection
        function handleIntermediatePage() {
          try {
            // Check if this is webview mode (fallback for Outlook rendering issues)
            var isWebView = window.location.search.indexOf('webview=1') > -1;

            // Hide email-only content
            var emailDivider = document.getElementById('email-divider');
            var emailExplanation = document.getElementById('email-explanation');
            var emailUnsubscribe = document.getElementById('email-unsubscribe');
            var emailFallbackLink = document.getElementById('email-fallback-link');

            if (emailDivider) emailDivider.style.display = 'none';
            if (emailExplanation) emailExplanation.style.display = 'none';
            if (emailUnsubscribe) emailUnsubscribe.style.display = 'none';
            if (emailFallbackLink) emailFallbackLink.style.display = 'none';

            // Handle email intro text
            var emailIntro = document.getElementById('email-intro');
            if (emailIntro) {
              if (isWebView) {
                // Webview mode: Extract ONLY the last paragraph (NPS question)
                var emailContent = emailIntro.innerHTML;

                // Create temporary div to parse HTML
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = emailContent;

                // Get all paragraphs
                var paragraphs = tempDiv.getElementsByTagName('p');
                var lastParagraphText = '';

                if (paragraphs.length > 0) {
                  // Get the last paragraph's text content
                  lastParagraphText = paragraphs[paragraphs.length - 1].textContent || paragraphs[paragraphs.length - 1].innerText || '';
                } else {
                  // If no paragraphs, use all text content
                  lastParagraphText = tempDiv.textContent || tempDiv.innerText || '';
                }

                // Show greeting and divider
                var greeting = document.getElementById('webview-greeting');
                if (greeting) {
                  greeting.style.display = 'block';
                }

                var divider = document.getElementById('webview-divider');
                if (divider) {
                  divider.style.display = 'block';
                }

                // Hide full email intro
                emailIntro.style.display = 'none';

                // Show NPS question only
                var npsQuestionOnly = document.getElementById('nps-question-only');
                if (npsQuestionOnly) {
                  npsQuestionOnly.textContent = lastParagraphText.trim();
                  npsQuestionOnly.style.display = 'block';
                }
              } else {
                // Normal intermediate page: Replace with simple question
                var existingText = emailIntro.textContent || emailIntro.innerText || '';
                var firmName = 'us';
                var firmMatch = existingText.match(/recommend\s+([^?]+)\?/i);
                if (firmMatch) {
                  firmName = firmMatch[1].trim();
                }
                emailIntro.innerHTML = '<p style="margin: 0; font-weight: 300; font-size: 16px; color: #212529;">How likely are you to recommend ' + firmName + '?</p>';
                emailIntro.style.textAlign = 'left';
                emailIntro.style.marginTop = '20px';
                emailIntro.style.marginBottom = '10px';
              }
            }

            // Read the score from URL fragment (#score=X)
            var hash = window.location.hash;
            var hasPreselectedScore = hash && hash.indexOf('score=') > -1;

            // Show confirmation mode if score is pre-selected (but NOT in webview mode)
            if (hasPreselectedScore && !isWebView) {
              // Show greeting and divider (same as webview)
              var greeting = document.getElementById('webview-greeting');
              if (greeting) {
                greeting.style.display = 'block';
              }

              var divider = document.getElementById('webview-divider');
              if (divider) {
                divider.style.display = 'block';
              }

              // Hide email intro (show NPS question only)
              if (emailIntro) {
                var existingText = emailIntro.textContent || emailIntro.innerText || '';
                var firmName = 'us';
                var firmMatch = existingText.match(/recommend\s+([^?]+)\?/i);
                if (firmMatch) {
                  firmName = firmMatch[1].trim();
                }
                emailIntro.innerHTML = '<p style="margin: 0; font-weight: 400; font-size: 21px; color: #212529; text-align: left;">How likely are you to recommend ' + firmName + '?</p>';
                emailIntro.style.textAlign = 'left';
                emailIntro.style.marginTop = '20px';
                emailIntro.style.marginBottom = '20px';
              }

              var preselectedScore = hash.split('score=')[1];
              var currentSelectedScore = preselectedScore;

              // Show Submit Score button
              var submitButtonContainer = document.getElementById('submit-score-button');
              if (submitButtonContainer) {
                submitButtonContainer.style.display = 'block';
              }

              // Get all score buttons
              var scoreButtons = document.querySelectorAll('.score-button');
              if (scoreButtons && scoreButtons.length > 0) {
                // Highlight the pre-selected button and set up click handlers
                for (var i = 0; i < scoreButtons.length; i++) {
                  var button = scoreButtons[i];
                  var buttonText = button.textContent.trim();

                  // Highlight the pre-selected button
                  if (buttonText === preselectedScore) {
                    button.style.backgroundColor = '#007bff';
                    button.style.borderColor = '#007bff';
                    button.style.setProperty('color', '#FFFFFF', 'important');
                  }

                  // Prevent default link behavior
                  button.addEventListener('click', function(e) {
                    e.preventDefault();
                    var clickedScore = this.textContent.trim();
                    currentSelectedScore = clickedScore;

                    // Remove highlight from all buttons
                    var allButtons = document.querySelectorAll('.score-button');
                    for (var j = 0; j < allButtons.length; j++) {
                      allButtons[j].style.backgroundColor = '#FFFFFF';
                      allButtons[j].style.borderColor = '#ccc';
                      allButtons[j].style.setProperty('color', '#222', 'important');
                    }

                    // Highlight clicked button
                    this.style.backgroundColor = '#007bff';
                    this.style.borderColor = '#007bff';
                    this.style.setProperty('color', '#FFFFFF', 'important');
                  });
                }
              }

              // Add Submit Score button click handler
              var submitButton = document.getElementById('btn-submit-score');
              if (submitButton) {
                submitButton.addEventListener('click', function() {
                  // Get base URL from current page
                  var currentUrl = window.location.href.split('?')[0].split('#')[0];
                  var baseUrl = currentUrl.replace('/survey.php', '/');

                  // Get survey parameters from URL
                  var params = new URLSearchParams(window.location.search);
                  var surveyId = params.get('id');
                  var surveyType = params.get('type');

                  // Get firm name from data attribute
                  var firmNameHolder = document.getElementById('firm-name-holder');
                  var firmName = firmNameHolder ? firmNameHolder.getAttribute('data-firm-name') : '';

                  // Navigate to feedback form with selected score and firm name
                  window.location.href = baseUrl + '?id=' + surveyId + '&type=' + surveyType + '&score=' + currentSelectedScore + '&firmName=' + encodeURIComponent(firmName);

                  // Close this window after a short delay
                  setTimeout(function() {
                    window.close();
                  }, 500);
                });
              }
            } else {
              // No pre-selected score
              var scoreButtons = document.querySelectorAll('.score-button');
              if (scoreButtons && scoreButtons.length > 0) {
                // Get firm name from data attribute
                var firmNameHolder = document.getElementById('firm-name-holder');
                var firmName = firmNameHolder ? firmNameHolder.getAttribute('data-firm-name') : '';

                for (var j = 0; j < scoreButtons.length; j++) {
                  var button = scoreButtons[j];
                  var buttonText = button.textContent.trim();
                  var currentHref = button.getAttribute('href');
                  if (currentHref) {
                    if (isWebView) {
                      // Webview mode: Direct link to survey form
                      currentHref = currentHref.replace('/survey.php', '/').split('#')[0];
                      button.setAttribute('href', currentHref + '&score=' + buttonText + '&firmName=' + encodeURIComponent(firmName));

                      // Remove target="_blank" so it opens in same window
                      button.removeAttribute('target');

                      // Add click handler to close window after navigation
                      button.addEventListener('click', function() {
                        setTimeout(function() {
                          window.close();
                        }, 500);
                      });
                    }
                  }
                }
              }
            }
          } catch (e) {
            console.error('Intermediate page error:', e);
          }
        }

        // Run when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', handleIntermediatePage);
        } else {
          handleIntermediatePage();
        }
      })();

      // Align labels with button edges (like Qualtrics)
      window.addEventListener('load', function() {
        alignLabels();
      });

      // Also re-align on resize
      window.addEventListener('resize', function() {
        alignLabels();
      });

      function alignLabels() {
        var buttons = document.querySelectorAll('.score-button');
        var labelsContainer = document.querySelector('.score-labels');

        if (buttons.length > 0 && labelsContainer) {
          var firstButton = buttons[0];
          var lastButton = buttons[buttons.length - 1];

          var firstRect = firstButton.getBoundingClientRect();
          var lastRect = lastButton.getBoundingClientRect();
          var containerRect = labelsContainer.parentElement.getBoundingClientRect();

          // Calculate the width from the left edge of first button to right edge of last button
          var labelsWidth = lastRect.right - firstRect.left;

          // Set the width and position of labels container
          labelsContainer.style.width = labelsWidth + 'px';
          labelsContainer.style.marginLeft = (firstRect.left - containerRect.left) + 'px';
        }
      }
    </script>

  </body>
</html>
